# Echo Wallet - 分步转账功能说明

## 功能概述

新的分步转账功能将转账过程拆分为多个清晰的步骤，每个步骤都有语音提示和确认，大大提升了盲人用户的使用安全性和体验。

## 转账流程

### 第一步：启动转账
**语音命令：** "转账"
- 系统检查钱包状态
- 如果提供完整信息（如"转账0.1ETH给小明"），自动解析并跳转到确认步骤
- 否则进入步骤引导模式

### 第二步：指定收款人
**语音提示：** "请告诉我转账给谁？您可以说联系人姓名或说出钱包地址"

**支持的输入方式：**
- 联系人姓名：如"小明"、"老板"、"朋友"
- 完整钱包地址：如"0x742d35Cc..."
- 模糊匹配：系统会智能匹配最相近的联系人

**语音反馈：**
- 找到联系人："收款人：小明"
- 找到地址："收款地址：742d...901A"
- 未找到："未找到联系人，请重新说明"

### 第三步：指定金额
**语音提示：** "现在请说明转账金额，例如：0.1 ETH"

**支持的金额表达：**
- 数字格式："0.1"、"0.05"、"1.5"
- 中文表达："零点一"、"零点零五"、"五毫"
- 带单位："0.1 ETH"、"50 USDC"

**金额验证：**
- 格式检查：确保为有效数字
- 范围检查：防止过大或过小的金额
- 精度修正：自动修正小数位数

### 第四步：指定代币类型（可选）
**语音提示：** "请说明代币类型，例如：ETH、USDC，或直接说'确认'使用ETH"

**支持的代币：**
- ETH（默认）
- USDC
- USDT

**智能跳过：**
如果在第三步已指定代币类型，此步骤会自动跳过

### 第五步：最终确认
**语音提示：** "请确认转账信息：转账 0.1 ETH 给 小明。请说'确认'执行转账，或说'取消'退出"

**确认选项：**
- "确认"、"是的"、"OK" - 执行转账
- "取消"、"不"、"退出" - 取消转账

## 安全特性

### 多重确认
1. **收款人确认**：系统会重复播报收款人信息
2. **金额确认**：金额会经过验证和格式化
3. **最终确认**：详细播报完整转账信息

### 错误处理
- **语音识别失败**：提供重试机会（最多3次）
- **信息不完整**：引导用户补充缺失信息
- **格式错误**：自动修正或提示重新输入

### 随时取消
- 任何步骤都可以说"取消"、"退出"立即中止转账
- 超过最大重试次数自动取消
- 长时间无响应自动超时取消

## 智能特性

### 联系人管理
- **模糊匹配**：支持名称的部分匹配
- **使用统计**：自动记录联系人使用频率
- **快速转账**：常用联系人可快速选择

### 语音优化
- **多种表达**：支持多种金额和代币的表达方式
- **误识别修正**：自动修正常见的语音识别错误
- **上下文理解**：根据当前步骤理解用户意图

### 完整命令支持
- **一句话转账**："转账0.1ETH给小明"
- **联系人转账**："转账给小明"（会询问金额）
- **快速转账**："快速转账0.05ETH"（使用最近联系人）

## 使用示例

### 示例1：联系人转账
```
用户："转账"
系统："开始转账流程。请告诉我转账给谁？"
用户："小明"
系统："收款人：小明。现在请说明转账金额"
用户："零点一以太"
系统："转账金额：0.1 ETH。请确认转账信息：转账 0.1 ETH 给 小明"
用户："确认"
系统："正在执行转账，请稍候..."
```

### 示例2：完整命令
```
用户："转账0.05USDC给老板"
系统："确认转账信息：转账 0.05 USDC 给 老板。请说'确认'执行转账"
用户："确认"
系统："正在执行转账..."
```

### 示例3：地址转账
```
用户："转账"
系统："请告诉我转账给谁？"
用户："0x742d35Cc1234567890123456789012345678901A"
系统："收款地址：742d...901A。现在请说明转账金额"
用户："五毫"
系统："转账金额：0.005。请说明代币类型"
用户："ETH"
系统："请确认转账信息：转账 0.005 ETH 给地址 742d...901A"
```

## 错误处理示例

### 语音识别失败
```
用户："转账"
系统："请告诉我转账给谁？"
用户：（说话不清楚）
系统："语音识别失败，请重新说明转账给谁"
```

### 联系人未找到
```
用户："张三"
系统："未找到联系人'张三'，请说出联系人姓名或完整的钱包地址"
```

### 金额格式错误
```
用户："很多钱"
系统："无法识别金额，请说明数字金额，例如：0.1 或 五十"
```

## 配置选项

### 重试次数
- 默认最大重试次数：3次
- 可在配置中调整

### 超时设置
- 语音输入超时：30秒
- 整个流程超时：5分钟

### 金额限制
- 最小金额：0.000001
- 最大金额：1000（可配置）
- 小数精度：最多6位

## 开发接口

### 核心方法
- `startTransferFlow()` - 开始转账流程
- `handleTransferStepInput()` - 处理步骤输入
- `cancelTransferFlow()` - 取消转账流程
- `resetTransferSteps()` - 重置转账状态

### 状态管理
```typescript
transferSteps = {
  isActive: boolean,
  step: 'idle' | 'recipient' | 'amount' | 'token' | 'confirm',
  recipient: { type: 'contact' | 'address', value: string, displayName?: string } | null,
  amount: string,
  token: string,
  attempts: number,
  maxAttempts: number
}
```

### 事件监听
- 语音识别结果处理
- 错误处理和重试
- 超时处理
- 取消操作处理

## 测试建议

### 基础测试
1. 正常流程测试（联系人转账）
2. 地址转账测试
3. 完整命令测试
4. 取消操作测试

### 异常测试
1. 语音识别失败处理
2. 联系人不存在处理
3. 金额格式错误处理
4. 网络错误处理

### 语音测试
1. 不同语速测试
2. 方言口音测试
3. 噪音环境测试
4. 长时间无操作测试

这个分步转账功能大大提升了用户体验的安全性和易用性，特别适合盲人用户逐步确认每个操作细节。
